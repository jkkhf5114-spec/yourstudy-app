<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>YourStudy Pro - Tech By Ashish Sir</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Cinzel:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #00d2ff; --secondary: #3a7bd5; --bg: #16222A; --text: #fff; --green: #00e676; --red: #ff1744; --gold: #FFD700; --purple: #a855f7; }
        body { background: linear-gradient(135deg, #16222A 0%, #3A6073 100%); color: white; font-family: 'Poppins', sans-serif; display: flex; justify-content: center; min-height: 100vh; margin: 0; overflow-x: hidden; }
        .container { width: 100%; max-width: 480px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); padding: 20px; min-height: 100vh; position: relative; border: 1px solid rgba(255,255,255,0.1); box-sizing: border-box; }
        .app-logo { display: block; margin: 0 auto 10px; width: 90px; border-radius: 15px; box-shadow: 0 0 15px var(--primary); }
        .school-name { font-family: 'Cinzel', serif; font-size: 16px; color: var(--gold); text-align: center; margin-bottom: 5px; }
        .screen { display: none; } .screen.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1; transform: translateY(0);} }

        input, select { width: 100%; padding: 14px; margin: 8px 0; border-radius: 12px; border: 1px solid #555; background: rgba(0,0,0,0.4); color: white; text-align: center; box-sizing: border-box; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; margin-top: 10px; color: white; transition: 0.3s; }
        .btn-primary { background: linear-gradient(to right, var(--primary), var(--secondary)); }
        .btn-battle { background: linear-gradient(45deg, #f43f5e, #fb7185); border-bottom: 4px solid #9f1239; margin-bottom: 15px; }

        .subject-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; }
        .sub-card { background: rgba(255,255,255,0.1); border-radius: 15px; padding: 15px; text-align: center; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); position: relative; overflow: hidden;}
        .test-item { background: white; color: #333; padding: 15px; margin-bottom: 12px; border-radius: 12px; border-left: 6px solid var(--secondary); display: flex; justify-content: space-between; align-items: center; font-weight: 600; cursor: pointer; }
        
        .opt-btn { width: 100%; padding: 16px; margin: 10px 0; border-radius: 12px; border: none; background: white; color: #333; text-align: left; padding-left: 20px; font-weight: 600; cursor: pointer; }
        .lifeline-row { display: flex; justify-content: space-around; margin: 10px 0; }
        .lifeline-btn { background: #1e293b; border: 2px solid var(--gold); color: var(--gold); border-radius: 50px; padding: 8px 15px; font-size: 11px; font-weight: bold; }
        .lifeline-btn.used { opacity: 0.3; filter: grayscale(1); pointer-events: none; }

        .back-nav { background: rgba(255,255,255,0.15); border: none; color: #fff; padding: 8px 15px; border-radius: 10px; font-size: 12px; margin-bottom: 10px; cursor: pointer; display: flex; align-items: center; gap: 5px; width: fit-content; }
        .free-quiz-box { border: 2px dashed var(--gold); border-radius: 15px; padding: 15px; margin-top: 20px; text-align: center; background: rgba(255,215,0,0.05); }

        /* --- NEW GAMIFICATION STYLES --- */
        .game-bar { display: flex; justify-content: space-around; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 15px; margin-bottom: 15px; font-size: 12px; font-weight: bold; border: 1px solid rgba(255,215,0,0.3); }
        .game-bar div { display: flex; align-items: center; gap: 4px; }
        
        .profile-section { display: flex; align-items: center; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 15px; margin-bottom: 15px; border: 1px solid var(--primary); position: relative;}
        .avatar-circle { width: 60px; height: 60px; border-radius: 50%; background: var(--gold); display: flex; align-items: center; justify-content: center; font-size: 30px; border: 3px solid #fff; box-shadow: 0 0 10px var(--primary); cursor: pointer;}
        .stats-box { margin-left: 15px; flex-grow: 1; }
        .level-badge { font-size: 10px; background: var(--primary); padding: 2px 8px; border-radius: 10px; font-weight: bold; }
        
        .map-mode-indicator { position: absolute; top: -10px; right: 10px; background: var(--purple); font-size: 9px; padding: 2px 8px; border-radius: 10px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.1);} 100% {transform: scale(1);} }

        .badge-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px 0; }
        .badge-item { opacity: 0.3; filter: grayscale(1); text-align: center; transition: 0.3s; }
        .badge-item.unlocked { opacity: 1; filter: grayscale(0); transform: scale(1.1); }
        .badge-item span { font-size: 24px; display: block; }
        .badge-item small { font-size: 8px; }

        .shop-item { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border: 1px solid rgba(255,255,255,0.1); }
        
        #timer-bar { width: 100%; height: 6px; background: rgba(255,255,255,0.2); border-radius: 10px; margin: 10px 0; overflow: hidden; }
        #timer-fill { width: 100%; height: 100%; background: var(--green); transition: 0.1s linear; }

        .leaderboard-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: white; color: #333; border-radius: 10px; margin-bottom: 8px; }
        .rank-circle { width: 25px; height: 25px; background: var(--secondary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; }

        .premium-sol-card { background: #fff; color: #333; padding: 15px; margin-bottom: 15px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-top: 5px solid var(--primary); position: relative; }
        .sol-q-no { background: var(--secondary); color: white; padding: 2px 10px; border-radius: 5px; font-size: 12px; font-weight: bold; margin-bottom: 8px; display: inline-block; }
        .sol-text { font-size: 14px; font-weight: 700; margin-bottom: 10px; display: block; line-height: 1.4; }
        .ans-badge { display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 8px; margin-top: 5px; font-size: 13px; font-weight: 600; }
        .user-choice { background: #fce4ec; border: 1px solid #f06292; color: #c2185b; }
        .correct-choice { background: #e8f5e9; border: 1px solid #66bb6a; color: #2e7d32; }
        .explanation-box { background: #e3f2fd; padding: 10px; border-radius: 8px; margin-top: 10px; border-left: 4px solid var(--primary); font-size: 12px; color: #444; }

        #statusCardBox { position: absolute; left: -9999px; width: 400px; height: 600px; background: linear-gradient(180deg, #1a2a6c, #b21f1f, #fdbb2d); padding: 30px; text-align: center; display: flex; flex-direction: column; justify-content: space-between; align-items: center; border: 10px solid gold; box-sizing: border-box; }
        .score-card { text-align: center; padding: 25px; background: rgba(0,0,0,0.4); border-radius: 25px; border: 2px solid var(--gold); margin-bottom: 20px; }
    </style>
</head>
<body>
<div class="container">
    <img src="study.png" class="app-logo">
    <div class="school-name">SHRI GAYATRI SANSKAAR</div>

    <div id="screen-login" class="screen active">
        <select id="pClassSelect">
            <option value="" disabled selected>Select Your Class</option>
            <option value="class5">Class 5th</option><option value="class6">Class 6th</option>
            <option value="class7">Class 7th</option><option value="class8">Class 8th</option>
            <option value="class9">Class 9th</option><option value="class10">Class 10th</option>
            <option value="sainik">Sainik Class</option>
        </select>
        <input type="text" id="pName" placeholder="Student Full Name">
        <input type="text" id="pRoll" placeholder="Roll Number">
        <input type="text" id="pDistrict" placeholder="Enter Your District">
        <button class="btn btn-primary" onclick="handleLogin()">ENTER DASHBOARD</button>

        <div class="free-quiz-box">
            <p style="margin:0; color:var(--gold); font-weight:bold;">‚ú® GUEST ZONE</p>
            <small>Free Quiz & Battle ke liye niche details bhariye!</small>
            <input type="text" id="freeName" placeholder="Aapka Naam">
            <input type="number" id="freeMobile" placeholder="Mobile Number">
            <button class="btn" style="background:var(--gold); color:#000; padding:10px; font-size:13px;" onclick="openFreeSubject()">PLAY FREE ZONE üöÄ</button>
        </div>
    </div>

    <div id="screen-dashboard" class="screen">
        <div class="game-bar">
            <div>üî• <span id="streakCount">0</span> Streak</div>
            <div>üí∞ <span id="coinCount">0</span> Coins</div>
            <div onclick="showScreen('screen-leaderboard')" style="cursor:pointer; color:var(--gold);">üèÜ Rank: <span id="userRank">--</span></div>
        </div>

        <div class="profile-section">
            <div class="map-mode-indicator">ADVENTURE MODE ON</div>
            <div class="avatar-circle" id="userAvatar" onclick="showScreen('screen-shop')">üê£</div>
            <div class="stats-box">
                <div id="dashName" style="font-weight:bold; font-size:14px;">Hero</div>
                <div class="level-badge" id="levelBadge">NOOB LEVEL</div>
                <div style="font-size:11px; color:var(--gold); margin-top:3px;">Points: <span id="userPoints">0</span></div>
            </div>
            <button onclick="showScreen('screen-shop')" style="background:none; border:none; font-size:20px;">üõí</button>
        </div>

        <div class="badge-grid" id="badgeGrid">
            <div class="badge-item" id="badge-1"><span>üéñÔ∏è</span><small>Beginner</small></div>
            <div class="badge-item" id="badge-2"><span>üî•</span><small>7 Days</small></div>
            <div class="badge-item" id="badge-3"><span>üíé</span><small>Pro</small></div>
            <div class="badge-item" id="badge-4"><span>üëë</span><small>Legend</small></div>
        </div>

        <p id="dashDist" style="text-align:center; color:var(--gold); font-size:12px;"></p>
        
        <button class="btn btn-battle" onclick="showScreen('screen-battle-lobby')">‚öîÔ∏è 1 VS 1 LIVE BATTLE</button>
        <button class="btn" style="background:var(--purple); margin-bottom:15px;" onclick="startBossBattle()">üëπ SURPRISE BOSS BATTLE</button>

        <div class="subject-grid">
            <div class="sub-card" onclick="openSubject('hindi', '‚úçÔ∏è Hindi')">‚úçÔ∏è<br>Hindi</div>
            <div class="sub-card" onclick="openSubject('english', 'üìö English')">üìö<br>English</div>
            <div class="sub-card" onclick="openSubject('maths', 'üî¢ Maths')">üî¢<br>Maths</div>
            <div class="sub-card" onclick="openSubject('science', 'üî¨ Science')">üî¨<br>Science</div>
            <div class="sub-card" onclick="openSubject('sst', 'üåç SST')">üåç<br>SST</div>
            <div class="sub-card" onclick="openSubject('gk', 'üß† GK')">üß†<br>GK</div>
            <div class="sub-card" onclick="openSubject('sanskrit', 'üïâÔ∏è Sanskrit')">üïâÔ∏è<br>Sanskrit</div>
        </div>
        <button class="back-nav" style="margin: 20px auto; display: block;" onclick="location.reload()">‚¨Ö Logout</button>
    </div>

    <div id="screen-shop" class="screen">
        <button class="back-nav" onclick="showScreen('screen-dashboard')">‚¨Ö Back</button>
        <h3 style="text-align:center;">üõí AVATAR SHOP</h3>
        <p style="text-align:center; color:var(--gold);">My Coins: üí∞ <span class="shop-coins">0</span></p>
        <div id="shopList">
            <div class="shop-item"><span>üî• Pro Aura</span> <button class="btn-primary" style="padding:5px 15px; border-radius:10px;" onclick="buyItem('üî•', 100)">100 üí∞</button></div>
            <div class="shop-item"><span>ü¶Å Lion King</span> <button class="btn-primary" style="padding:5px 15px; border-radius:10px;" onclick="buyItem('ü¶Å', 500)">500 üí∞</button></div>
            <div class="shop-item"><span>üëë Legend</span> <button class="btn-primary" style="padding:5px 15px; border-radius:10px;" onclick="buyItem('üëë', 1000)">1000 üí∞</button></div>
        </div>
    </div>

    <div id="screen-leaderboard" class="screen">
        <button class="back-nav" onclick="showScreen('screen-dashboard')">‚¨Ö Back</button>
        <h3 style="text-align:center;">üèÜ GLOBAL RANKING</h3>
        <div id="leaderboardList">
            <p style="text-align:center;">Loading Top Players...</p>
        </div>
    </div>

    <div id="screen-battle-lobby" class="screen">
        <button class="back-nav" id="backFromBattleLobby" onclick="showScreen('screen-dashboard')">‚¨Ö Back</button>
        <h3 style="text-align:center;">‚öîÔ∏è BATTLE ROOM</h3>
        <div class="glass-card" style="background:rgba(255,255,255,0.05); padding:15px; border-radius:20px; text-align:center;">
            <p>Battle ID se Join Karein</p>
            <input type="number" id="battleJoinInput" placeholder="Enter Number ID (e.g. 5114)">
            <button class="btn btn-primary" onclick="joinBattle()">JOIN BATTLE üöÄ</button>
        </div>
        <hr>
        <p style="text-align:center; font-size:12px;">YAA APNI BATTLE BANAYEIN</p>
        <button class="btn" id="battleCreationRedirect" style="background:var(--gold); color:black;" onclick="showScreen('screen-dashboard')">SELECT SUBJECT FOR BATTLE</button>
    </div>

    <div id="screen-tests" class="screen">
        <button class="back-nav" id="backFromTests" onclick="showScreen('screen-dashboard')">‚¨Ö Back</button>
        <div id="testListContainer"></div>
    </div>

    <div id="screen-quiz" class="screen">
        <button class="back-nav" onclick="quitQuiz()">‚¨Ö Quit Quiz</button>
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div id="qCounter" style="font-weight:bold; font-size:13px;"></div>
            <div id="timerTxt" style="color:var(--gold); font-weight:bold;">25s</div>
            <div id="livesBox" style="color:var(--red);">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
        </div>
        <div id="timer-bar"><div id="timer-fill"></div></div>
        
        <div class="lifeline-row">
            <button class="lifeline-btn" id="ll-50" onclick="use5050()">50:50 KBC</button>
            <button class="lifeline-btn" onclick="alert('Hint: Check Notes!')">HINT üí°</button>
        </div>
        <img id="qImage" style="width:100%; border-radius:15px; display:none; margin-bottom: 10px; border: 2px solid white;">
        <h4 id="qText" style="margin-top:0;"></h4>
        <div id="optionsBox"></div>
    </div>

    <div id="screen-result" class="screen">
        <div class="score-card">
            <h2 id="finalScore" style="font-size:45px; color:var(--gold); margin:10px 0;">0/0</h2>
            <div id="resBattleInfo" style="color:var(--primary); font-weight:bold; margin-bottom:10px;"></div>
            <div id="resStudentName">NAME</div>
            <div id="pointsEarned" style="color:var(--green); font-size:14px; font-weight:bold;">+0 Points Earned!</div>
            <div id="coinsEarned" style="color:var(--gold); font-size:12px;">+0 Coins Added! üí∞</div>
        </div>
        <button class="btn" style="background:#25D366;" onclick="shareOnWhatsApp()">üì¢ WHATSAPP REPORT</button>
        <button class="btn" style="background:var(--gold); color:#000;" onclick="downloadStatusCard()">üì• DOWNLOAD CERTIFICATE</button>
        
        <div id="statusCardBox">
            <div style="font-family:'Cinzel'; color:gold; font-size:24px; font-weight:bold;">SHRI GAYATRI SANSKAAR PUBLIC SCHOOL</div>
            <div style="color:white; margin: 20px 0;">
                <p style="font-size: 16px; margin:0;">CONGRATULATIONS!</p>
                <h2 id="cardStudentName" style="color:white; font-size:32px; margin:10px 0; text-decoration: underline;"></h2>
                <div style="font-size:60px; font-weight:800; color:#FFD700; margin:10px 0;" id="cardScore"></div>
                <p id="cardChapter" style="color:white; font-weight:600; font-size:16px; margin:5px 0;"></p>
                <p id="cardSubject" style="color:white; font-weight:bold; font-size:18px; margin:0;"></p>
            </div>
            <div style="width:100%;">
                <div style="background:white; color:#b21f1f; font-weight:900; padding:10px; border-radius:50px; font-size:20px; margin-bottom:10px;">ADMISSION OPEN</div>
                <div style="color:white; font-size:14px; font-weight:bold; letter-spacing: 1px;">BRAND: TECH BY ASHISH</div>
            </div>
        </div>

        <button class="btn" onclick="location.reload()" style="background:rgba(255,255,255,0.1)">HOME</button>
        <h3 style="margin-top:25px; border-left:5px solid var(--primary); padding-left:10px;">üìù Solution Key</h3>
        <div id="solutionContainer" style="margin-top:15px;"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, getDocs, setDoc, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCwoI-wBaaKAXpuAKsjbYk3-e4WqPaclD4",
      authDomain: "gk-hub-65131.firebaseapp.com",
      projectId: "gk-hub-65131",
      storageBucket: "gk-hub-65131.firebasestorage.app",
      messagingSenderId: "480430253862",
      appId: "1:480430253862:web:ded94efa855772d83283e7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.player = {}; window.currentQuiz = []; window.currQIndex = 0;
    window.lives = 3; window.userAnswers = []; window.isBattle = false; window.battleID = null;
    window.timer = null; 
    
    // Initializing Local Data
    window.points = parseInt(localStorage.getItem('study_points')) || 0;
    window.coins = parseInt(localStorage.getItem('study_coins')) || 0;
    window.streak = parseInt(localStorage.getItem('study_streak')) || 0;
    window.lastActive = localStorage.getItem('study_lastDate') || "";

    // --- DEVICE LOCK & LOGIN (SAME) ---
    window.handleLogin = async () => {
        const name = document.getElementById('pName').value.trim();
        const roll = document.getElementById('pRoll').value.trim();
        const dist = document.getElementById('pDistrict').value.trim();
        const cls = document.getElementById('pClassSelect').value;
        
        if(!name || !roll || !cls || !dist) return alert("Sari fields bhariye!");

        try {
            const deviceID = navigator.userAgent + "_" + screen.width;
            const lockRef = doc(db, "settings", "device_locks");
            const lockSnap = await getDoc(lockRef);
            
            if(lockSnap.exists()) {
                const lockedDevices = lockSnap.data();
                if(lockedDevices[roll] && lockedDevices[roll] !== deviceID) {
                    return alert("‚ö†Ô∏è Device Locked! Sir se contact karein: 8517935114");
                }
            }
            await setDoc(lockRef, { [roll]: deviceID }, { merge: true });

            const accessSnap = await getDoc(doc(db, "daily_quiz", cls));
            if(accessSnap.exists() && accessSnap.data().meta?.allowedIDs?.includes(roll)) {
                window.player = { name, roll, class: cls, district: dist };
                handleStreaks();
                updateDashboardUI();
                syncLeaderboard();
                showScreen('screen-dashboard');
            } else { alert("‚ùå Access Denied!contact 8517935114"); }
        } catch (e) { alert("Internet Issue!"); }
    };

    // --- STREAK LOGIC ---
    function handleStreaks() {
        const today = new Date().toDateString();
        if(window.lastActive === "") {
            window.streak = 1;
        } else {
            const last = new Date(window.lastActive);
            const diff = Math.floor((new Date(today) - last) / (1000 * 60 * 60 * 24));
            if(diff === 1) window.streak++;
            else if(diff > 1) window.streak = 1;
        }
        window.lastActive = today;
        localStorage.setItem('study_streak', window.streak);
        localStorage.setItem('study_lastDate', today);
    }

    function updateDashboardUI() {
        document.getElementById('dashName').innerText = window.player.name;
        document.getElementById('dashDist').innerText = "üìç " + window.player.district;
        document.getElementById('userPoints').innerText = window.points;
        document.getElementById('coinCount').innerText = window.coins;
        document.getElementById('streakCount').innerText = window.streak;
        document.querySelector('.shop-coins').innerText = window.coins;

        let level = "NOOB"; let avatar = localStorage.getItem('user_avatar') || "üê£";
        if(window.points >= 1000) level="LEGEND";
        else if(window.points >= 500) level="PRO";
        
        document.getElementById('levelBadge').innerText = level + " LEVEL";
        document.getElementById('userAvatar').innerText = avatar;

        // Badge Unlocking
        if(window.points > 0) document.getElementById('badge-1').classList.add('unlocked');
        if(window.streak >= 7) document.getElementById('badge-2').classList.add('unlocked');
        if(window.points >= 500) document.getElementById('badge-3').classList.add('unlocked');
        if(window.points >= 1000) document.getElementById('badge-4').classList.add('unlocked');
    }

    // --- LEADERBOARD & SHOP ---
    async function syncLeaderboard() {
        if(!window.player.roll) return;
        await setDoc(doc(db, "leaderboard", window.player.roll), {
            name: window.player.name, points: window.points, avatar: document.getElementById('userAvatar').innerText
        }, {merge: true});

        const q = query(collection(db, "leaderboard"), orderBy("points", "desc"), limit(10));
        const snap = await getDocs(q);
        const list = document.getElementById('leaderboardList');
        list.innerHTML = "";
        let rank = 1;
        snap.forEach(d => {
            const data = d.data();
            if(d.id === window.player.roll) document.getElementById('userRank').innerText = "#"+rank;
            list.innerHTML += `<div class="leaderboard-item">
                <div class="rank-circle">${rank}</div>
                <span>${data.avatar}</span>
                <b style="flex-grow:1">${data.name}</b>
                <span style="color:var(--secondary)">${data.points} pts</span>
            </div>`;
            rank++;
        });
    }

    window.buyItem = (icon, price) => {
        if(window.coins >= price) {
            window.coins -= price;
            localStorage.setItem('study_coins', window.coins);
            localStorage.setItem('user_avatar', icon);
            updateDashboardUI();
            alert("Item Bought! Avatar Updated.");
            showScreen('screen-dashboard');
        } else { alert("Not enough coins!"); }
    };

    // --- TIMER & QUIZ LOGIC (SAME AS PREVIOUS) ---
    function startTimer() {
        let timeLeft = 25;
        const fill = document.getElementById('timer-fill');
        const txt = document.getElementById('timerTxt');
        clearInterval(window.timer);
        window.timer = setInterval(() => {
            timeLeft--;
            txt.innerText = timeLeft + "s";
            fill.style.width = (timeLeft / 25) * 100 + "%";
            if(timeLeft <= 0) { clearInterval(window.timer); nextQuestion(); }
        }, 1000);
    }

    window.openSubject = async (subKey, title) => {
        window.currentSubject = title; 
        showScreen('screen-tests');
        const qSnap = await getDocs(collection(db, "quizzes"));
        const cont = document.getElementById('testListContainer');
        cont.innerHTML = `<h3 style="text-align:center;">${title}</h3>`;
        let count = 1;
        qSnap.forEach(d => {
            if(d.data().class === window.player.class && d.data().subject === subKey) {
                cont.innerHTML += `<div class="test-item"><span>${count}. ${d.data().title}</span> 
                    <div style="display:flex; gap:5px;">
                        <button onclick="startTest('${d.id}')" style="background:var(--green); border:none; color:white; padding:5px; border-radius:5px;">PLAY</button>
                        <button onclick="createBattle('${d.id}')" style="background:var(--red); border:none; color:white; padding:5px; border-radius:5px;">BATTLE</button>
                    </div></div>`;
                count++;
            }
        });
    };

    window.startBossBattle = async () => {
        alert("üëπ BOSS CHALLENGE: 15sec timer per question! Double Points!");
        const qSnap = await getDocs(collection(db, "quizzes"));
        const allTests = []; qSnap.forEach(d => allTests.push(d.id));
        const randomID = allTests[Math.floor(Math.random()*allTests.length)];
        startTest(randomID);
        // Boss Battle logic: speed up timer
        window.timerDuration = 15;
    };

    window.startTest = async (id, battle = false) => {
        window.isBattle = battle;
        const s = await getDoc(doc(db, "quizzes", id));
        window.currentQuiz = s.data().questions;
        window.currentTestTitle = s.data().title;
        window.currQIndex = 0; window.lives = 3; window.userAnswers = [];
        showScreen('screen-quiz'); loadQ();
    };

    function loadQ() {
        const q = window.currentQuiz[window.currQIndex];
        document.getElementById('qCounter').innerText = `Q: ${window.currQIndex+1}/${window.currentQuiz.length}`;
        document.getElementById('qText').innerText = q.q;
        const img = document.getElementById('qImage');
        if(q.img) { img.src = q.img; img.style.display = "block"; } else { img.style.display = "none"; }
        const box = document.getElementById('optionsBox'); box.innerHTML = "";
        q.opts.forEach((o, i) => {
            const b = document.createElement('button'); b.className = "opt-btn"; b.innerText = o;
            b.onclick = () => checkAns(i, b); box.appendChild(b);
        });
        startTimer();
    }

    function checkAns(idx, btn) {
        clearInterval(window.timer);
        const correct = window.currentQuiz[window.currQIndex].a;
        window.userAnswers[window.currQIndex] = idx;
        if(idx === correct) { btn.style.background = "var(--green)"; btn.style.color="white"; }
        else {
            btn.style.background = "var(--red)"; btn.style.color="white";
            window.lives--; updateLives();
        }
        setTimeout(nextQuestion, 800);
    }

    function nextQuestion() {
        window.currQIndex++;
        if(window.currQIndex < window.currentQuiz.length) loadQ(); else finish();
    }

    async function finish() {
        clearInterval(window.timer);
        let score = 0;
        window.currentQuiz.forEach((q, i) => { if(window.userAnswers[i] === q.a) score++; });
        
        let earnedPts = score * 10;
        let earnedCoins = score * 5;
        window.points += earnedPts;
        window.coins += earnedCoins;
        
        localStorage.setItem('study_points', window.points);
        localStorage.setItem('study_coins', window.coins);
        
        document.getElementById('pointsEarned').innerText = `+${earnedPts} Points Earned!`;
        document.getElementById('coinsEarned').innerText = `+${earnedCoins} Coins Added! üí∞`;
        
        updateDashboardUI();
        syncLeaderboard();

        document.getElementById('finalScore').innerText = `${score}/${window.currentQuiz.length}`;
        if(window.isBattle) {
            const bRef = doc(db, "live_battles", window.battleID);
            const bSnap = await getDoc(bRef);
            if(bSnap.data().challengerName === window.player.name) await setDoc(bRef, { challengerScore: score }, { merge: true });
            else await setDoc(bRef, { opponentScore: score }, { merge: true });
            document.getElementById('resBattleInfo').innerText = "Waiting for Opponent...";
            listenToBattle(); 
        }
        renderSolutions();
        showScreen('screen-result');
    }

    // --- (CERTIFICATE, BATTLE, WHATSAPP FUNCTIONS - SAME AS PREVIOUS) ---
    window.createBattle = async (quizID) => {
        const rid = Math.floor(100000 + Math.random() * 900000).toString();
        window.battleID = rid;
        await setDoc(doc(db, "live_battles", rid), {
            quizID: quizID, challengerName: window.player.name, challengerScore: -1, opponentName: "Waiting...", opponentScore: -1, status: "waiting"
        });
        alert(`Room ID: ${rid}`);
        window.open(`https://wa.me/?text=Mujhse 1vs1 Battle khelo! ID: ${rid}`);
        listenToBattle();
    };

    window.joinBattle = async () => {
        const id = document.getElementById('battleJoinInput').value.trim();
        const bSnap = await getDoc(doc(db, "live_battles", id));
        if(bSnap.exists()) {
            window.battleID = id;
            await setDoc(doc(db, "live_battles", id), { opponentName: window.player.name, status: "active" }, { merge: true });
            startTest(bSnap.data().quizID, true);
        } else { alert("Wrong ID!"); }
    };

    function listenToBattle() {
        onSnapshot(doc(db, "live_battles", window.battleID), (doc) => {
            const data = doc.data(); if(!data) return;
            if(data.status === "active" && !window.isBattle) startTest(data.quizID, true);
            if(data.challengerScore !== -1 && data.opponentScore !== -1) showBattleResult(data);
        });
    }

    function showBattleResult(data) {
        let opponent = data.challengerName === window.player.name ? data.opponentName : data.challengerName;
        let oppScore = data.challengerName === window.player.name ? data.opponentScore : data.challengerScore;
        let myScore = data.challengerName === window.player.name ? data.challengerScore : data.opponentScore;
        let winStatus = myScore > oppScore ? "üèÜ YOU WON!" : (myScore === oppScore ? "ü§ù DRAW!" : "‚ùå YOU LOST!");
        document.getElementById('resBattleInfo').innerHTML = `${winStatus}<br><small>${opponent} Score: ${oppScore}</small>`;
    }

    function renderSolutions() {
        const sol = document.getElementById('solutionContainer'); sol.innerHTML = "";
        window.currentQuiz.forEach((q, i) => {
            const userChoiceIdx = window.userAnswers[i]; const correctIdx = q.a; const isCorrect = userChoiceIdx === correctIdx;
            sol.innerHTML += `<div class="premium-sol-card"><span class="sol-q-no">Q ${i+1}</span><span class="sol-text">${q.q}</span>
                    <div class="ans-badge ${isCorrect ? 'correct-choice' : 'user-choice'}"><span>${isCorrect ? '‚úÖ' : '‚ùå'} Aapka: <b>${userChoiceIdx !== null ? q.opts[userChoiceIdx] : 'Skipped'}</b></span></div>
                    ${!isCorrect ? `<div class="ans-badge correct-choice"><span>‚úÖ Sahi: <b>${q.opts[correctIdx]}</b></span></div>` : ''}
                    <div class="explanation-box"><b>üí° Sol:</b> ${q.sol || 'Basic Solution'}</div></div>`;
        });
    }

    window.downloadStatusCard = () => {
        document.getElementById('cardStudentName').innerText = window.player.name.toUpperCase();
        document.getElementById('cardScore').innerText = document.getElementById('finalScore').innerText;
        document.getElementById('cardChapter').innerText = "TEST: " + window.currentTestTitle;
        document.getElementById('cardSubject').innerText = "SUBJECT: " + window.currentSubject;
        const card = document.getElementById('statusCardBox'); card.style.position = "static"; card.style.left = "0";
        html2canvas(card, { scale: 2 }).then(canvas => {
            const link = document.createElement('a'); link.href = canvas.toDataURL(); link.download = `Certificate.png`; link.click();
            card.style.position = "absolute"; card.style.left = "-9999px";
        });
    };

    window.use5050 = () => {
        const correct = window.currentQuiz[window.currQIndex].a;
        const btns = document.querySelectorAll('.opt-btn');
        let hidden = 0;
        btns.forEach((b, i) => { if(i !== correct && hidden < 2) { b.style.display = "none"; hidden++; } });
        document.getElementById('ll-50').classList.add('used');
    };

    function updateLives() { 
        document.getElementById('livesBox').innerText = window.lives > 0 ? "‚ù§Ô∏è".repeat(window.lives) : "No Lives (Keep Going!)"; 
    }
    window.showScreen = (id) => { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); };
    window.quitQuiz = () => { if(confirm('Quit?')) { clearInterval(window.timer); location.reload(); } };
    
    window.shareOnWhatsApp = () => {
        const msg = `*SHRI GAYATRI SANSKAAR*\n*üìä QUIZ REPORT*\n\n*Student:* ${window.player.name}\n*Score:* ${document.getElementById('finalScore').innerText}\n*Test:* ${window.currentTestTitle}\n*Subject:* ${window.currentSubject}\n\n*ADMISSION OPEN*\n*Tech By Ashish Sir*`;
        window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`);
    };

    window.openFreeSubject = async () => {
        const fName = document.getElementById('freeName').value.trim();
        const fMob = document.getElementById('freeMobile').value.trim();
        if(!fName || !fMob) return alert("Fill Guest Details!");
        window.player = { name: fName, roll: fMob, class: "free", district: "Guest" };
        window.currentSubject = "Free Zone";
        showScreen('screen-tests');
        const qSnap = await getDocs(collection(db, "quizzes"));
        const cont = document.getElementById('testListContainer');
        cont.innerHTML = `<h3>‚ú® Guest Zone</h3>`;
        qSnap.forEach(d => { if(d.data().class === "free") { cont.innerHTML += `<div class="test-item"><span>${d.data().title}</span> <button onclick="startTest('${d.id}')">PLAY</button></div>`; } });
    }
</script>
</body>
</html>